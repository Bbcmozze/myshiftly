{% extends "base.html" %}

{% block title %}–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ê–Ω–∞–ª–∏–∑ - My Shiftly{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/Analysis/analysis.css') }}">
{% endblock %}

{% block content %}
<div class="analysis-container">
    <div class="analysis-header">
        <h1><i class="bi bi-clipboard-data-fill"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –ê–Ω–∞–ª–∏–∑</h1>
        <div class="header-controls">
            <div class="comparison-toggle">
                <label class="toggle-switch">
                    <input type="checkbox" id="comparisonMode">
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">–°—Ä–∞–≤–Ω–∏—Ç—å –ø–µ—Ä–∏–æ–¥—ã</span>
                </label>
            </div>
            <div class="period-selector">
                <div class="period-group" id="primaryPeriod">
                    <label class="period-label">–ü–µ—Ä–∏–æ–¥:</label>
                    <select id="periodSelect" class="period-select">
                        <option value="week">–ù–µ–¥–µ–ª—è</option>
                        <option value="month" selected>–ú–µ—Å—è—Ü</option>
                        <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="year">–ì–æ–¥</option>
                    </select>
                    <input type="month" id="monthPicker" class="month-picker" value="{{ current_month.strftime('%Y-%m') }}">
                </div>
                <div class="period-group comparison-period" id="comparisonPeriod" style="display: none;">
                    <label class="period-label">–°—Ä–∞–≤–Ω–∏—Ç—å —Å:</label>
                    <select id="comparisonPeriodSelect" class="period-select">
                        <option value="week">–ù–µ–¥–µ–ª—è</option>
                        <option value="month" selected>–ú–µ—Å—è—Ü</option>
                        <option value="quarter">–ö–≤–∞—Ä—Ç–∞–ª</option>
                        <option value="year">–ì–æ–¥</option>
                    </select>
                    <input type="month" id="comparisonMonthPicker" class="month-picker">
                </div>
            </div>
        </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –∫–∞–ª–µ–Ω–¥–∞—Ä–∏ -->
    <section class="filters-section">
        <div class="section-header">
            <h2><i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <button class="filter-toggle-btn" id="filterToggle">
                <i class="bi bi-chevron-down"></i>
                <span>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</span>
            </button>
        </div>
        
        <div class="calendars-selector" id="calendarsSelector">
            {% for calendar in calendars %}
            <div class="calendar-checkbox">
                <input type="checkbox" id="calendar_{{ calendar.id }}" value="{{ calendar.id }}" 
                       class="calendar-input" data-role="{{ calendar_roles[calendar.id] }}" {% if loop.first %}checked{% endif %}>
                <label for="calendar_{{ calendar.id }}" class="calendar-label">
                    <i class="bi bi-calendar-week"></i>
                    <span>{{ calendar.name }}</span>
                    <small>
                        {% if calendar_roles[calendar.id] == 'creator' %}
                            {{ calendar.members|length + 1 }} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–ª–∞–¥–µ–ª–µ—Ü)
                        {% else %}
                            –£—á–∞—Å—Ç–Ω–∏–∫
                        {% endif %}
                    </small>
                </label>
            </div>
            {% endfor %}
        </div>

        <div class="advanced-filters" id="advancedFilters" style="display: none;">
            <div class="filters-header">
                <i class="bi bi-funnel"></i>
                <h4>–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h4>
            </div>
            
            <div class="filters-grid">
                <div class="filter-card">
                    <div class="filter-icon">
                        <i class="bi bi-people"></i>
                    </div>
                    <div class="filter-content">
                        <label class="filter-label">–£—á–∞—Å—Ç–Ω–∏–∫–∏</label>
                        <div class="participants-filter">
                            <div class="participants-dropdown" id="participantsDropdown">
                                <div class="participants-trigger" id="participantsTrigger">
                                    <span class="participants-placeholder">–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</span>
                                    <i class="bi bi-chevron-down"></i>
                                </div>
                                <div class="participants-list" id="participantsList">
                                    <div class="participants-search">
                                        <i class="bi bi-search"></i>
                                        <input type="text" placeholder="–ü–æ–∏—Å–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤..." id="participantsSearch">
                                    </div>
                                    <div class="participants-options" id="participantsOptions">
                                        <div class="participant-option all-option" data-value="">
                                            <div class="participant-checkbox">
                                                <input type="checkbox" id="all-participants" checked>
                                                <label for="all-participants"></label>
                                            </div>
                                            <div class="participant-info">
                                                <div class="participant-avatar">
                                                    <i class="bi bi-people-fill"></i>
                                                </div>
                                                <div class="participant-details">
                                                    <div class="participant-name">–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</div>
                                                    <div class="participant-username">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Hidden select for form compatibility -->
                            <select id="userFilter" class="hidden-select" multiple style="display: none;">
                                <option value="">–í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="filter-card">
                    <div class="filter-icon">
                        <i class="bi bi-palette"></i>
                    </div>
                    <div class="filter-content">
                        <label class="filter-label">–¢–∏–ø —Å–º–µ–Ω</label>
                        <div class="shift-types-filter">
                            <div class="shift-types-dropdown" id="shiftTypesDropdown">
                                <div class="shift-types-trigger" id="shiftTypesTrigger">
                                    <span class="shift-types-placeholder">–í—Å–µ —Ç–∏–ø—ã</span>
                                    <i class="bi bi-chevron-down"></i>
                                </div>
                                <div class="shift-types-list" id="shiftTypesList">
                                    <div class="shift-types-search">
                                        <i class="bi bi-search"></i>
                                        <input type="text" placeholder="–ü–æ–∏—Å–∫ —Ç–∏–ø–æ–≤ —Å–º–µ–Ω..." id="shiftTypesSearch">
                                    </div>
                                    <div class="shift-types-options" id="shiftTypesOptions">
                                        <div class="shift-type-option all-option" data-value="">
                                            <div class="shift-type-checkbox">
                                                <input type="checkbox" id="all-shift-types" checked>
                                                <label for="all-shift-types"></label>
                                            </div>
                                            <div class="shift-type-info">
                                                <div class="shift-type-color">
                                                    <i class="bi bi-palette-fill"></i>
                                                </div>
                                                <div class="shift-type-details">
                                                    <div class="shift-type-name">–í—Å–µ —Ç–∏–ø—ã</div>
                                                    <div class="shift-type-description">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Hidden select for form compatibility -->
                            <select id="shiftTypeFilter" class="hidden-select" multiple style="display: none;">
                                <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="filter-card">
                    <div class="filter-icon">
                        <i class="bi bi-hourglass"></i>
                    </div>
                    <div class="filter-content">
                        <label class="filter-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
                        <div class="custom-select-wrapper">
                            <select id="durationFilter" class="custom-select">
                                <option value="">–õ—é–±–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</option>
                                <option value="short">‚ö° –ö–æ—Ä–æ—Ç–∫–∏–µ (&lt;4—á)</option>
                                <option value="medium">‚è∞ –°—Ä–µ–¥–Ω–∏–µ (4-8—á)</option>
                                <option value="long">üî• –î–ª–∏–Ω–Ω—ã–µ (&gt;8—á)</option>
                            </select>
                            <i class="bi bi-chevron-down select-arrow"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="btn-reset" id="resetFilters">
                    <i class="bi bi-arrow-clockwise"></i>
                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                </button>
                <button class="btn-apply" id="applyFilters">
                    <i class="bi bi-check2"></i>
                    –ü—Ä–∏–º–µ–Ω–∏—Ç—å
                </button>
            </div>
        </div>
    </section>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
    <div class="info-panel" id="participantInfo" style="display: none;">
        <div class="info-content">
            <i class="bi bi-info-circle"></i>
            <div class="info-text">
                <strong>–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</strong>
                <p>–í—ã –≤–∏–¥–∏—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–ª—å–∫–æ –ø–æ —Å–≤–æ–∏–º —Å–º–µ–Ω–∞–º. –†–∞–∑–¥–µ–ª—ã "–ê–Ω–∞–ª–∏–∑ –∫–æ–º–∞–Ω–¥—ã", "–ë–∞–ª–∞–Ω—Å –Ω–∞–≥—Ä—É–∑–∫–∏" –∏ "–ê–Ω–∞–ª–∏–∑ –ø–æ–∫—Ä—ã—Ç–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è" —Å–∫—Ä—ã—Ç—ã, —Ç–∞–∫ –∫–∞–∫ –≤—ã –Ω–µ —è–≤–ª—è–µ—Ç–µ—Å—å —Å–æ–∑–¥–∞—Ç–µ–ª–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π.</p>
            </div>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–º–µ–Ω–∞–º -->
    <section class="stats-section">
        <div class="section-header">
            <h2><i class="bi bi-clock-history"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–º–µ–Ω–∞–º</h2>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-stopwatch"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalHours">0</h3>
                    <p>–û–±—â–µ–µ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã</p>
                    <span class="stat-period">–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-calendar-check"></i>
                </div>
                <div class="stat-content">
                    <h3 id="totalShifts">0</h3>
                    <p>–í—Å–µ–≥–æ —Å–º–µ–Ω</p>
                    <span class="stat-period">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-clock"></i>
                </div>
                <div class="stat-content">
                    <h3 id="avgShiftDuration">0—á 0–º</h3>
                    <p>–°—Ä–µ–¥–Ω—è—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</p>
                    <span class="stat-period">—Å–º–µ–Ω—ã</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="bi bi-star-fill"></i>
                </div>
                <div class="stat-content">
                    <h3 id="topTemplate">-</h3>
                    <p>–ü–æ–ø—É–ª—è—Ä–Ω—ã–π —à–∞–±–ª–æ–Ω</p>
                    <span class="stat-period">—á–∞—â–µ –≤—Å–µ–≥–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è</span>
                </div>
            </div>
        </div>

        <div class="charts-row">
            <div class="chart-container">
                <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–±–æ—á–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
                <canvas id="workTimeChart"></canvas>
            </div>
            <div class="chart-container">
                <h3>–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h3>
                <canvas id="weekdayChart"></canvas>
            </div>
        </div>
    </section>

    <!-- –ê–Ω–∞–ª–∏–∑ –∫–æ–º–∞–Ω–¥—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä–µ–π) -->
    <section class="team-section" id="teamSection">
        <div class="section-header">
            <h2><i class="bi bi-people-fill"></i> –ê–Ω–∞–ª–∏–∑ –∫–æ–º–∞–Ω–¥—ã</h2>
        </div>
        
        <div class="team-stats-grid">
            <div class="team-card">
                <h3>–†–µ–π—Ç–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h3>
                <div class="activity-ranking" id="activityRanking">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>
            
            <div class="team-card">
                <h3>–ë–∞–ª–∞–Ω—Å –Ω–∞–≥—Ä—É–∑–∫–∏</h3>
                <canvas id="workloadBalanceChart"></canvas>
            </div>
        </div>

        <div class="team-details">
            <div class="coverage-analysis">
                <h3>–ê–Ω–∞–ª–∏–∑ –ø–æ–∫—Ä—ã—Ç–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è</h3>
                <div class="coverage-legend">
                    <div class="legend-item">
                        <div class="legend-color excellent"></div>
                        <span>–û—Ç–ª–∏—á–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (80%+)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color good"></div>
                        <span>–•–æ—Ä–æ—à–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (60-79%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color fair"></div>
                        <span>–°—Ä–µ–¥–Ω–µ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (30-59%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color poor"></div>
                        <span>–°–ª–∞–±–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ (1-29%)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color empty"></div>
                        <span>–ù–µ—Ç —Å–º–µ–Ω (0%)</span>
                    </div>
                </div>
                <div class="coverage-grid" id="coverageGrid">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>
        </div>
    </section>

    <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã -->
    <section class="trends-section">
        <div class="section-header">
            <h2><i class="bi bi-graph-up"></i> –í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã</h2>
        </div>
        
        <div class="trends-container">
            <div class="trend-chart-container">
                <h3>–ì—Ä–∞—Ñ–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ –º–µ—Å—è—Ü–∞–º</h3>
                <div class="chart-controls">
                    <button class="chart-btn active" data-metric="hours">–ß–∞—Å—ã</button>
                    <button class="chart-btn" data-metric="shifts">–°–º–µ–Ω—ã</button>
                    <button class="chart-btn" data-metric="people">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
                </div>
                <canvas id="trendsChart"></canvas>
            </div>
            
            <div class="seasonal-patterns">
                <h3>–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å —à–∞–±–ª–æ–Ω–æ–≤ —Å–º–µ–Ω</h3>
                <div class="shift-templates" id="shiftTemplates">
                    <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
                </div>
            </div>
        </div>
    </section>
</div>

<!-- Loading overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">
        <div class="spinner"></div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
// Ensure Chart.js is loaded before initializing
window.addEventListener('load', function() {
    console.log('Window loaded, Chart.js available:', typeof Chart !== 'undefined');
    if (typeof Chart === 'undefined') {
        console.error('Chart.js failed to load from CDN');
    }
});
</script>
<script src="{{ url_for('static', filename='js/Analysis/analysis.js') }}"></script>
{% endblock %}
