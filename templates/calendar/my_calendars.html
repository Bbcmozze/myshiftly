{% extends "base.html" %}

{% block title %}Мои календари - My Shiftly{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/calendar/list.css') }}">
{% endblock %}

{% block content %}
<!-- Модальное окно для подтверждения удаления -->
<div id="deleteModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Подтверждение удаления</h3>
            <button class="modal-close" onclick="closeDeleteModal()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="delete-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <p>Вы уверены, что хотите удалить календарь <strong id="calendarNameToDelete"></strong>?</p>
                <p class="warning-text">Это действие нельзя отменить. Все данные календаря будут безвозвратно удалены.</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">Отмена</button>
            <button class="btn btn-danger" onclick="confirmDelete()">Удалить календарь</button>
        </div>
    </div>
</div>

<div class="calendars-container">
    <div class="calendars-header">
        <h2>Мои календари</h2>
        <a href="{{ url_for('create_calendar') }}" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Создать новый
        </a>
    </div>

    <div class="calendar-tabs">
        <div class="tab-header">
            <button class="tab-btn active" data-tab="personal">Личные</button>
            <button class="tab-btn" data-tab="team">Командные</button>
            <button class="tab-btn" data-tab="shared">Общие</button>
        </div>

        <div class="tab-content active" id="personal-tab">
            {% if personal_calendars %}
            <div class="calendar-grid">
                {% for calendar in personal_calendars %}
                <div class="calendar-card">
                    <div class="calendar-header">
                        <button class="delete-btn" onclick="deleteCalendar({{ calendar.id }}, '{{ calendar.name }}')" title="Удалить календарь">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </div>
                    <div class="calendar-info">
                        <h3>{{ calendar.name }}</h3>
                        <p>Личный календарь</p>
                        <div class="calendar-meta">
                            <span><i class="bi bi-calendar3"></i> {{ calendar.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                    </div>
                    <div class="calendar-actions">
                        <a href="{{ url_for('view_calendar', calendar_id=calendar.id) }}" class="btn btn-sm btn-primary">
                            Открыть
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-calendars">
                <i class="bi bi-calendar-x"></i>
                <h3>Нет личных календарей</h3>
                <p>Создайте личный календарь для управления своими сменами</p>
            </div>
            {% endif %}
        </div>

        <div class="tab-content" id="team-tab">
            {% if team_calendars %}
            <div class="calendar-grid">
                {% for calendar in team_calendars %}
                <div class="calendar-card">
                    <div class="calendar-header">
                        <button class="delete-btn" onclick="deleteCalendar({{ calendar.id }}, '{{ calendar.name }}')" title="Удалить календарь">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </div>
                    <div class="calendar-info">
                        <h3>{{ calendar.name }}</h3>
                        <p>Командный календарь · {{ calendar.members|length }} участников</p>
                        <div class="calendar-meta">
                            <span><i class="bi bi-calendar3"></i> {{ calendar.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                    </div>
                    <div class="calendar-actions">
                        <a href="{{ url_for('view_calendar', calendar_id=calendar.id) }}" class="btn btn-sm btn-primary">
                            Открыть
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-calendars">
                <i class="bi bi-calendar-x"></i>
                <h3>Нет командных календарей</h3>
                <p>Создайте командный календарь для управления сменами ваших коллег</p>
            </div>
            {% endif %}
        </div>

        <div class="tab-content" id="shared-tab">
            {% if shared_calendars %}
            <div class="calendar-grid">
                {% for calendar in shared_calendars %}
                <div class="calendar-card">
                    {% if calendar.owner_id == current_user.id %}
                    <div class="calendar-header">
                        <button class="delete-btn" onclick="deleteCalendar({{ calendar.id }}, '{{ calendar.name }}')" title="Удалить календарь">
                            <i class="bi bi-trash3"></i>
                        </button>
                    </div>
                    {% endif %}
                    <div class="calendar-info">
                        <h3>{{ calendar.name }}</h3>
                        <p>Общий календарь · Создатель: {{ calendar.owner.username }}</p>
                        <div class="calendar-meta">
                            <span><i class="bi bi-calendar3"></i> {{ calendar.created_at.strftime('%d.%m.%Y') }}</span>
                        </div>
                    </div>
                    <div class="calendar-actions">
                        <a href="{{ url_for('view_calendar', calendar_id=calendar.id) }}" class="btn btn-sm btn-primary">
                            Открыть
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="no-calendars">
                <i class="bi bi-calendar-x"></i>
                <h3>Нет общих календарей</h3>
                <p>Здесь будут отображаться календари, которыми с вами поделились</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/friends/search.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.getAttribute('data-tab');
            
            // Убираем активные классы у всех кнопок и контента
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            
            // Добавляем активные классы к выбранной кнопке и контенту
            btn.classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
        });
    });
});

let currentCalendarId = null;

function deleteCalendar(calendarId, calendarName) {
    currentCalendarId = calendarId;
    document.getElementById('calendarNameToDelete').textContent = calendarName;
    document.getElementById('deleteModal').classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('active');
    document.body.style.overflow = '';
    currentCalendarId = null;
}

function confirmDelete() {
    if (currentCalendarId) {
        // Создаем форму для отправки POST запроса
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/calendar/${currentCalendarId}/delete`;
        
        // Добавляем CSRF токен если он есть
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Закрытие модального окна при клике вне его
document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('deleteModal');
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            closeDeleteModal();
        }
    });
    
    // Закрытие по Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            closeDeleteModal();
        }
    });
});
</script>
{% endblock %}